-- Database Schema for Westufer Kemnade Booking System
-- Compatible with PostgreSQL (Supabase / Vercel Postgres)

-- 1. Course Definitions (Templates)
CREATE TABLE courses (
  id SERIAL PRIMARY KEY,
  slug VARCHAR(50) UNIQUE NOT NULL, -- e.g., 'windsurf-grundschein'
  title VARCHAR(100) NOT NULL,
  description TEXT,
  duration_minutes INT NOT NULL,
  price_cents INT NOT NULL, -- Price in cents to avoid float issues
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Availability Slots (Specific dates/times)
CREATE TABLE course_slots (
  id SERIAL PRIMARY KEY,
  course_id INT REFERENCES courses(id) ON DELETE CASCADE,
  start_time TIMESTAMP WITH TIME ZONE NOT NULL,
  max_capacity INT NOT NULL DEFAULT 8,
  booked_count INT NOT NULL DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  -- Prevent double booking the exact same course at same time
  UNIQUE(course_id, start_time)
);

-- 3. Bookings (Customer reservations)
CREATE TABLE bookings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slot_id INT REFERENCES course_slots(id),
  customer_name VARCHAR(100) NOT NULL,
  customer_email VARCHAR(150) NOT NULL,
  customer_phone VARCHAR(50),
  status VARCHAR(20) DEFAULT 'pending', -- pending, paid, cancelled
  stripe_session_id VARCHAR(200) UNIQUE,
  payment_intent_id VARCHAR(200),
  amount_total_cents INT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Rental Items (Inventory for rental system)
CREATE TABLE rental_items (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL, -- e.g., 'SUP Board', 'Neoprenanzug'
  category VARCHAR(50) NOT NULL, -- 'board', 'wetsuit'
  total_quantity INT NOT NULL DEFAULT 0,
  price_per_hour_cents INT NOT NULL
);

-- Indexes for performance
CREATE INDEX idx_course_slots_start_time ON course_slots(start_time);
CREATE INDEX idx_bookings_email ON bookings(customer_email);
CREATE INDEX idx_bookings_stripe_session ON bookings(stripe_session_id);
